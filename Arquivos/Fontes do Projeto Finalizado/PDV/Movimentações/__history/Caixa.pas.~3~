unit Caixa;

interface

uses
  Winapi.Windows, Winapi.Messages, System.SysUtils, System.Variants, System.Classes, Vcl.Graphics,
  Vcl.Controls, Vcl.Forms, Vcl.Dialogs, Data.DB, Vcl.ComCtrls, Vcl.Grids,
  Vcl.DBGrids, Vcl.StdCtrls, Vcl.Buttons;

type
  TFrmCaixa = class(TForm)
    Label2: TLabel;
    Label4: TLabel;
    Label5: TLabel;
    btnNovo: TSpeedButton;
    btnAbrir: TSpeedButton;
    BtnFechar: TSpeedButton;
    Label3: TLabel;
    EdtUsuario: TEdit;
    DBGrid1: TDBGrid;
    edtSenha: TEdit;
    edtValor: TEdit;
    edtCaixa: TEdit;
    Label1: TLabel;
    dataBuscar: TDateTimePicker;
    btnRelatorio: TSpeedButton;
    procedure FormShow(Sender: TObject);
    procedure btnNovoClick(Sender: TObject);
    procedure dataBuscarChange(Sender: TObject);
    procedure btnAbrirClick(Sender: TObject);
  private
    { Private declarations }

     procedure limpar;
      procedure habilitarCampos;
      procedure desabilitarCampos;

      procedure associarCampos;
      procedure listar;


      procedure buscarData;
  public
    { Public declarations }
  end;

var
  FrmCaixa: TFrmCaixa;
  gerente: string;
  cargoGerente: string;

implementation

{$R *.dfm}

uses Modulo, Vendas;

procedure TFrmCaixa.associarCampos;
begin
   dm.tb_caixa.FieldByName('data_abertura').Value := DateToStr(Date);
   dm.tb_caixa.FieldByName('hora_abertura').Value := TimeToStr(Time);
  dm.tb_caixa.FieldByName('valor_abertura').Value := strToFloat(edtValor.Text);
  dm.tb_caixa.FieldByName('funcionario_abertura').Value := gerente;
  dm.tb_caixa.FieldByName('num_caixa').Value := edtCaixa.Text;
  dm.tb_caixa.FieldByName('operador').Value := nomeUsuario;


end;

procedure TFrmCaixa.btnAbrirClick(Sender: TObject);
begin
     if  Trim(EdtValor.Text) = '' then
       begin
           MessageDlg('Preencha o Valor!', mtInformation, mbOKCancel, 0);
           EdtValor.SetFocus;
           exit;
       end;


        if  Trim(EdtCaixa.Text) = '' then
       begin
           MessageDlg('Preencha o Caixa!', mtInformation, mbOKCancel, 0);
           EdtCaixa.SetFocus;
           exit;
       end;


       //VERIFICAR PERMISSAO DO GERENTE
         dm.query_usuarios.Close;
       dm.query_usuarios.SQL.Clear;
       dm.query_usuarios.SQL.Add('SELECT * from usuarios where usuario = :usuario and senha = :senha');
        dm.query_usuarios.ParamByName('usuario').Value := edtUsuario.Text;
         dm.query_usuarios.ParamByName('senha').Value := edtSenha.Text;
       dm.query_usuarios.Open;

       if not dm.query_usuarios.isEmpty then
       begin
         gerente :=  dm.query_usuarios['nome'];
         cargoGerente :=  dm.query_usuarios['cargo'];

         //VERIFICAR SE QUEM LOGOU FOI UM OPERADOR DE CAIXA
         if cargoGerente <> 'Gerente' then
         begin

           EdtSenha.Text := '';
            MessageDlg('Você não tem permissão de Gerente!', mtInformation, mbOKCancel, 0);
           exit;
         end;



          end
          else
          begin
           MessageDlg('Dados de Login Incorretos!!', mtInformation, mbOKCancel, 0);
           edtusuario.Text := '';
           EdtSenha.Text := '';
           edtUsuario.SetFocus;
           exit;
       end;



        associarCampos;
        dm.tb_caixa.Post;
        MessageDlg('Salvo com Sucesso', mtInformation, mbOKCancel, 0);

         FrmVendas := TFrmVendas.Create(self);
         FrmVendas.ShowModal;
end;

procedure TFrmCaixa.btnNovoClick(Sender: TObject);
begin
  habilitarCampos;
  dm.tb_caixa.Insert;
  btnAbrir.Enabled := true;
end;

procedure TFrmCaixa.buscarData;
begin
  dm.query_caixa.Close;
       dm.query_caixa.SQL.Clear;
       dm.query_caixa.SQL.Add('SELECT * from caixa where data_abertura = :data order by data_abertura desc');
       dm.query_caixa.ParamByName('data').Value := FormatDateTime('yyyy/mm/dd' ,dataBuscar.Date);
       dm.query_caixa.Open;
end;

procedure TFrmCaixa.dataBuscarChange(Sender: TObject);
begin
buscarData;
end;

procedure TFrmCaixa.desabilitarCampos;
begin
edtUsuario.Enabled := false;
edtSenha.Enabled := false;
edtvalor.Enabled := false;
edtCaixa.Enabled := false;
end;

procedure TFrmCaixa.FormShow(Sender: TObject);
begin

  desabilitarCampos;
  dm.tb_caixa.Active := true;
  listar;


if statusCaixa = 'Abertura' then
begin
btnNovo.Enabled := true;
end;

end;

procedure TFrmCaixa.habilitarCampos;
begin
edtUsuario.Enabled := true;
edtSenha.Enabled := true;
edtvalor.Enabled := true;
edtCaixa.Enabled := true;
end;

procedure TFrmCaixa.limpar;
begin
edtUsuario.Text := '';
edtSenha.Text := '';
edtvalor.Text := '';
edtCaixa.Text := '';
end;

procedure TFrmCaixa.listar;
begin
       dm.query_caixa.Close;
       dm.query_caixa.SQL.Clear;
       dm.query_caixa.SQL.Add('SELECT * from caixa where data_abertura = curDate() ');
       //dm.query_caixa.ParamByName('data').Value := FormatDateTime('yyyy/mm/dd' ,dataBuscar.Date);
       dm.query_caixa.Open;
end;

end.
